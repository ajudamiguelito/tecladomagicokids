<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Teclado Infantil ‚Äî Falante & Ca√ßa</title>
<style>
/* ==========================================================================
   CONFIGURA√á√ÉO DE VARI√ÅVEIS E ESTILOS GLOBAIS
   ========================================================================== */
:root {
  --bg: #bfe0ff; /* Cor de fundo principal (azul claro) */
  --panel: #ffffff; /* Cor de fundo do painel do teclado (branco) */
  --key: #ffd54a; /* Cor padr√£o das teclas (amarelo) */
  --key-shadow: #f0b300; /* Cor da sombra das teclas (amarelo escuro) */
  --accent: #8b63f3; /* Cor de destaque (roxo) */
  --purple: #9b6ef7; /* Cor roxa principal para bot√µes e detalhes */
}

body{
  margin:0;
  font-family: "Comic Sans MS", "Trebuchet MS", Arial, sans-serif; 
  background: var(--bg);
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:22px;
  -webkit-font-smoothing:antialiased;
  overflow-x:hidden;
}

/* ==========================================================================
   ESTILOS DA BARRA SUPERIOR (TOPBAR)
   ========================================================================== */
.topbar { 
  width: 100%; 
  max-width:1100px; 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  gap:12px; 
  margin-bottom:18px; 
  flex-wrap:wrap; 
}

.modes { display:flex; gap:12px; flex-wrap:wrap; }
.mode-btn { 
  background: linear-gradient(0deg,#bda8ff,#cdb8ff); 
  padding:10px 18px; 
  border-radius:10px; 
  color:white; 
  font-weight:700; 
  border:none; 
  cursor:pointer; 
  box-shadow: 0 6px rgba(0,0,0,0.08); 
  transition: all 0.1s ease;
}
.mode-btn.active { 
  background: linear-gradient(0deg,var(--purple),#b894ff); 
  box-shadow:0 8px rgba(0,0,0,0.12); 
  transform: translateY(-2px);
}

.controls-right { 
  display:flex; 
  align-items:center; 
  gap:14px; 
  flex-wrap:wrap; 
}
.activity-btn { 
  background: var(--purple); 
  color: white; 
  padding:12px 16px; 
  border-radius:8px; 
  border:none; 
  font-weight:700; 
  cursor:pointer; 
  transition: background 0.1s ease;
}

/* ==========================================================================
   ESTILOS DO DISPLAY (VISOR)
   ========================================================================== */
#display { 
  width: 100%; 
  max-width:1100px; 
  margin: 6px 0 18px 0; 
  display:flex; 
  justify-content:center; 
  align-items:center; 
}
.display-box { 
  background: linear-gradient(180deg,#fff,#f6f0ff); 
  padding:18px 36px; 
  border-radius:18px; 
  box-shadow: 0 10px 30px rgba(0,0,0,0.12); 
  font-size:34px; 
  font-weight:700; 
  color:#222; 
  min-width:420px; 
  text-align:center; 
  cursor:text; 
  word-break: keep-all;
  overflow-wrap: anywhere;
}

/* ==========================================================================
   ESTILOS DO PAINEL DO TECLADO E TECLAS
   ========================================================================== */
.keyboard-panel { 
  width:100%; 
  max-width:1100px; 
  background: var(--panel); 
  border-radius:18px; 
  padding:26px; 
  box-shadow: 0 14px 30px rgba(0,0,0,0.12); 
  overflow-x:auto; 
}
.row { 
  display:flex; 
  justify-content:center; 
  gap:8px; 
  margin:10px 0; 
  flex-wrap:wrap;
}
.key { 
  background: var(--key); 
  border-radius:10px; 
  width:64px; 
  height:64px; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  font-weight:800; 
  font-size:18px; 
  color:#222; 
  border:none; 
  box-shadow: 0 6px var(--key-shadow); 
  cursor:pointer; 
  user-select:none; 
  transition: transform 0.09s ease, box-shadow 0.09s; 
}
.key.space { width: 300px; }
.key.playing { 
  transform: translateY(6px); 
  box-shadow: 0 0 rgba(0,0,0,0.06); 
  background: #ff9f1a; 
  color: white; 
}

/* ==========================================================================
   FEEDBACK + CRON√îMETRO + BOT√ÉO PARAR
   ========================================================================== */
.feedback { 
  margin-top:14px; 
  display:flex; 
  justify-content:space-between; 
  align-items:center; 
  gap:12px; 
  max-width:1100px; 
  width:100%; 
}
.feedback .status { 
  background: linear-gradient(180deg,#fff,#f6f0ff); 
  padding:12px 18px; 
  border-radius:12px; 
  font-weight:700; 
  min-width:360px; 
  text-align:center; 
  box-shadow:0 8px rgba(0,0,0,0.06); 
}

/* Grupo com bot√£o vermelho + cron√¥metro */
.timer-group {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* Bot√£o vermelho "Parar Tudo" */
.stop-btn {
  background: #ff4b4b;
  color: white;
  border: none;
  padding: 12px 18px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 6px rgba(0, 0, 0, 0.08);
  transition: all 0.1s ease;
}
.stop-btn:active {
  transform: translateY(2px);
  box-shadow: 0 3px rgba(0, 0, 0, 0.1);
}

/* Cron√¥metro */
.timer-circle { 
  width:72px; 
  height:72px; 
  border-radius:50%; 
  background:var(--purple); 
  color:white; 
  font-weight:700; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  font-size:20px; 
  box-shadow:0 8px rgba(0,0,0,0.08); 
}

/* ==========================================================================
   BOT√ÉO a/A
   ========================================================================== */
#btnToggleCase {
  background-color: var(--accent);
  padding: 10px 18px;
  border-radius: 10px;
  color: white;
  font-weight: 700;
  border: none;
  cursor: pointer;
  box-shadow: 0 6px rgba(0,0,0,0.08);
  transition: all 0.1s ease;
  font-size: 14px;
  align-self: center;
  margin-left: auto;
}
#btnToggleCase.active {
  background-color: #5c33d6;
  transform: translateY(-2px);
  box-shadow: 0 8px rgba(0,0,0,0.12);
}

/* ==========================================================================
   ESTILOS DO PLACAR (SCORE-BOARD)
   ========================================================================== */
.score-board {
  width: 100%; 
  max-width: 1100px; 
  display: flex; 
  justify-content: center; /* Centraliza os bot√µes */
  gap: 12px; 
  margin-top: 18px; /* Espa√ßamento da se√ß√£o anterior */
  flex-wrap: wrap; /* Para lidar com telas menores */
}

.score-btn { 
  padding: 12px 24px; 
  border-radius: 10px; 
  color: white; 
  font-weight: 700; 
  border: none; 
  cursor: pointer; 
  box-shadow: 0 6px rgba(0,0,0,0.1); 
  transition: all 0.1s ease;
  min-width: 120px; /* Garante que os bot√µes tenham um tamanho decente */
}

/* Cor para Acertos (Verde) */
.score-btn.success {
  background: linear-gradient(0deg, #4CAF50, #81C784); /* Verde */
}

/* Cor para Erros (Vermelho) */
.score-btn.error { 
  background: linear-gradient(0deg, #F44336, #E57373); /* Vermelho */
}

/* Cor para Reiniciar (Amarelo) */
.score-btn.reset { 
  background: linear-gradient(0deg, #FFC107, #FFD54F); /* Amarelo */
  color: #333; /* Texto escuro no bot√£o amarelo */
}

.score-btn:active {
  transform: translateY(2px);
  box-shadow: 0 3px rgba(0, 0, 0, 0.1);
}

/* ==========================================================================
   MEDIA QUERY ‚Äî MODO MOBILE
   ========================================================================== */
@media (max-width: 900px){
    body { padding: 8px; }
    .key { width: 5.8vw; height: 5.8vw; font-size: 3.0vw; }
    .row { gap: 2px; margin: 2px 0; }
    .key.space { width: 38vw; }
    .keyboard-panel { padding: 0.6vw; }
    .display-box { font-size: 3.5vw; min-width: auto; padding: 2.5vw; }
    .feedback { justify-content: center; }
    .feedback .status {
        padding: 1.7vw 2.5vw;
        min-width: 70%;
        max-width: 80%;
        font-size: 2.5vw;
        text-align: left;
    }
    #display { margin: 4px 0 4px 0; }
    .mode-btn, .activity-btn {
        font-size: 3.0vw;
        padding: 2.0vw 3.5vw;
    }
    .timer-circle {
        width: 8.5vw;
        height: 8.5vw;
        font-size: 3.5vw;
    }
    .timer-group { gap: 6px; }
    .stop-btn {
        padding: 1.8vw 3vw;
        font-size: 2.8vw;
        border-radius: 8px;
    }

    /* üëá ESTILOS DE CORRE√á√ÉO PARA O PLACAR (SCORE-BOARD) üëá */
    .score-board {
        justify-content: space-between; 
        gap: 4px; /* Reduz o gap entre bot√µes */
    }

    .score-btn { 
        min-width: unset; /* Remove o min-width fixo */
        flex-grow: 1; /* Permite que ocupe o espa√ßo dispon√≠vel */
        padding: 2.0vw 1.5vw; /* Ajusta o padding vertical/horizontal */
        font-size: 2.8vw; /* Reduz o tamanho da fonte */
    }
}</style>

</head>
<body>

<!-- BARRA SUPERIOR: Modos e Controles de Atividade -->
<div class="topbar">
  <div class="modes">
    <button id="modeTalk" class="mode-btn active">üéµ Teclado Falante</button>
    <button id="modeHunt" class="mode-btn">üéØ Letras / N√∫meros</button>
    <button id="btnStop" class="mode-btn" style="background: linear-gradient(0deg, #ff6666, #ff8c8c);">‚èπÔ∏è Parar</button>
  </div>
  <div class="controls-right">
    <button id="btnLetters" class="activity-btn">Letras</button>
    <button id="btnNumbers" class="activity-btn">N√∫meros</button>
    <div id="timerCircle" class="timer-circle">10</div>
  </div>
</div>

<!-- DISPLAY PRINCIPAL -->
<div id="display">
  <div class="display-box" id="mainDisplay">Voc√™ pressionou: ‚Äî</div>
</div>

<!-- PAINEL DO TECLADO (Onde as teclas s√£o injetadas via JS) -->
<div class="keyboard-panel" id="keyboardPanel">
  <div class="row" id="row1"></div>
  <div class="row" id="row2"></div>
  <div class="row" id="row3"></div>
  <div class="row" id="row4"></div>
  <div class="row" id="row5"></div>
</div>

<!-- BARRA DE FEEDBACK E STATUS -->
<div class="feedback">
¬† <div class="status" id="statusBox">Modo: Falante ‚Äî Clique numa tecla ou use o teclado.</div>
¬† <button id="btnToggleCase">A/a</button> ¬† <div style="width:20px"></div>
</div>

<!-- BARRA DE placar -->
<div class="score-board">
  <button id="btnAcertos" class="score-btn success">Acertos: 0</button>
  <button id="btnErros" class="score-btn error">Erros: 0</button>
  <button id="btnReiniciar" class="score-btn reset">Reiniciar</button>
</div>

<!-- INPUT OCULTO PARA ATIVAR TECLADO VIRTUAL EM DISPOSITIVOS M√ìVEIS -->
<input type="text" id="hiddenInput" style="position:absolute;opacity:0;pointer-events:none;" >

<script>

// --- C√ìDIGO DE RESTRI√á√ÉO DE DOM√çNIO (CORRE√á√ÉO FINAL) ---

// Dom√≠nios permitidos (APENAS DOM√çNIOS PRINCIPAIS ENTRE ASPAS E SEPARADOS POR V√çRGULA)
const DOMINIOS_PERMITIDOS = [
    "club.hotmart.com",   // Essencial: O dom√≠nio da √°rea de membros
    "hotmart.com",        // Dom√≠nio principal para cobrir varia√ß√µes de URL
    "app.hotmart.com"     // Dom√≠nio de gerenciamento/app da Hotmart
];

// O restante do c√≥digo de verifica√ß√£o
const urlDeOrigem = window.parent.location.hostname;
let acessoPermitido = false;

for (const dominio of DOMINIOS_PERMITIDOS) {
    if (urlDeOrigem.includes(dominio)) {
        acessoPermitido = true;
        break; 
    }
}

if (!acessoPermitido) {
    document.body.innerHTML = '<div style="text-align: center; padding-top: 50px;">' +
                              '<h1>‚õî Acesso Negado</h1>' +
                              '<p>Conte√∫do exclusivo para alunos. Por favor, acesse atrav√©s do link oficial da Hotmart Club.</p>' +
                              '</div>';
    
    throw new Error('Restri√ß√£o de dom√≠nio ativada. Aplica√ß√£o interrompida.'); 
}
// O seu c√≥digo do teclado vem AP√ìS este bloco.

/* ==========================================================================
   CONFIGURA√á√ÉO INICIAL E VARI√ÅVEIS
   ========================================================================== */

// Layout das teclas do teclado virtual
const layout = [
  ['1','2','3','4','5','6','7','8','9','0'],
  ['Q','W','E','R','T','Y','U','I','O','P'],
  ['A','S','D','F','G','H','J','K','L'],
  ['Z','X','C','V','B','N','M'],
  ];

// Refer√™ncias aos elementos DOM
const keyboardPanel = document.getElementById('keyboardPanel');
const rows = [
  document.getElementById('row1'), 
  document.getElementById('row2'), 
  document.getElementById('row3'), 
  document.getElementById('row4'), 
  document.getElementById('row5')
];
const mainDisplay = document.getElementById('mainDisplay');
const statusBox = document.getElementById('statusBox');
const timerCircle = document.getElementById('timerCircle');
const hiddenInput = document.getElementById('hiddenInput');
// üí° ADICIONE AS REFER√äNCIAS DO PLACAR AQUI üí°
// Refer√™ncias aos elementos DOM do placar
const btnAcertos = document.getElementById('btnAcertos');
const btnErros = document.getElementById('btnErros');
const btnReiniciar = document.getElementById('btnReiniciar');
// üí° FIM DA ADI√á√ÉO üí°
// Vari√°veis de estado
let mode = 'talk'; // 'talk' (falante) ou 'hunt' (ca√ßa)
let huntCategory = 'letters'; // 'letters' (letras) ou 'numbers' (n√∫meros)
let huntTarget = null; // A letra/n√∫mero que o usu√°rio deve encontrar no modo 'hunt'
let timerSeconds = 10; // Tempo inicial do cron√¥metro
let timerInterval = null; // ID do intervalo do cron√¥metro
let voices = []; // Lista de vozes dispon√≠veis
let speakingVoice = null; // A voz selecionada para a fala (preferencialmente feminina em portugu√™s)
let isUpperCase = false; // Novo estado para controlar mai√∫sculas/min√∫sculas
let isSpeaking = false; // ‚Üê Nova flag: indica se a voz est√° falando
// Vari√°veis para o Placar
let scoreHits = 0;
let scoreMisses = 0;
const keyElements = new Map(); // ‚Üê ADICIONE ESTA LINHA AQUI


// Mapa de pron√∫ncia para letras do alfabeto em portugu√™s
const pronunciaLetra = {
  'A':'a','B':'b√™','C':'c√™','D':'d√™','E':'√©','F':'efe','G':'g√™','H':'ag√°','I':'i','J':'jota',
  'K':'c√°','L':'ele','M':'eme','N':'ene','O':'√≥','P':'p√™','Q':'qu√™','R':'erre','S':'essi','T':'t√™',
  'U':'√ö','V':'v√™','W':'d√°blio','X':'xis','Y':'√≠psilon','Z':'z√™' // Adicionado para consist√™ncia
};
const pronunciaNumero = {
  '0':'zero', '1':'um', '2':'dois', '3':'tr√™s', '4':'quatr√≥', 
  '5':'cinco', '6':'seis', '7':'sete', '8':'oito', '9':'nove'
};

// Conjuntos de letras e n√∫meros para o modo Ca√ßa
const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
const numbers = '0123456789'.split('');


/* ==========================================================================
   CRIA√á√ÉO DIN√ÇMICA DO TECLADO
   ========================================================================== */

/**
 * Cria ou atualiza as teclas do teclado virtual com base no estado `isUpperCase`.
 */
function createKeyboardKeys() {
    layout.forEach((rowKeys, rowIndex) => {
        const row = rows[rowIndex];
        row.innerHTML = ''; // Limpa a linha antes de recriar as teclas

        rowKeys.forEach(key => {
            const btn = document.createElement('button');
            btn.className = 'key';
            // Define o texto da tecla: "Espa√ßo" para 'Space', ou a pr√≥pria letra/n√∫mero
            // *** AQUI USA o isUpperCase! ***
            const displayKey = (key === 'Space') ? 'Espa√ßo' : (isUpperCase ? key.toUpperCase() : key.toLowerCase());
            btn.textContent = displayKey;    
            if (key === 'Space') btn.classList.add('space');
            btn.dataset.key = key; // Armazena o valor real da tecla para refer√™ncia
            // Adiciona o manipulador de evento de clique para a intera√ß√£o da tecla
            btn.addEventListener('click', ()=> handleKeyInteraction(key));  
            row.appendChild(btn);
			keyElements.set(key.toUpperCase(), btn); // ‚Üê Aqui salva a refer√™ncia
        });
    });
}
/**
 * Aplica um efeito visual de 'pressionado' na tecla.
 * @param {string} key - O valor da tecla (ex: 'A', '1', 'Space').
 */
function flashKey(key){
  const el = keyElements.get(key.toUpperCase());
  if(el){
    el.classList.add('playing');
    setTimeout(()=>el.classList.remove('playing'), 260);
  }
}



/* ==========================================================================
   S√çNTESE DE VOZ (SPEECH SYNTHESIS)
   ========================================================================== */

/**
 * Carrega e seleciona a voz em Portugu√™s (pt-BR).
 */
function loadVoices(){
  // Filtra apenas vozes em portugu√™s
  voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('pt')); 
  // Tenta encontrar uma voz feminina, sen√£o usa a primeira dispon√≠vel
  speakingVoice = voices.find(v => v.name.toLowerCase().includes('female')) || voices[0] || null; 
}
// Recarrega as vozes quando o evento onvoiceschanged √© disparado (necess√°rio em alguns browsers)
speechSynthesis.onvoiceschanged = loadVoices; 
loadVoices(); // Chama na inicializa√ß√£o

// üîß Corre√ß√£o ‚Äî alguns navegadores demoram para carregar as vozes
if (speechSynthesis.getVoices().length === 0) {
  setTimeout(loadVoices, 500);
}

/**
 * Faz a leitura do texto usando a voz selecionada.
 * @param {string} text - O texto a ser falado.
 * @param {object} opts - Op√ß√µes de fala (pitch e rate).
 */
function speak(text, opts = {}) {
  if(!('speechSynthesis' in window)) return;
  
  // Cancela qualquer fala anterior
  speechSynthesis.cancel();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'pt-BR';
  if(speakingVoice) u.voice = speakingVoice;
  u.pitch = opts.pitch ?? 1.8;
  u.rate = opts.rate ?? 1.00;

  // Marca como falando
  isSpeaking = true;

  // Quando terminar de falar, volta ao normal
  u.onend = () => { isSpeaking = false; };

  speechSynthesis.speak(u);
}

/* ==========================================================================
   Gera√ß√£o de Sons (Beeps e Sucesso)
   ========================================================================== */

/**
 * Toca um beep simples usando a Web Audio API.
 * @param {number} freq - Frequ√™ncia do som (Hz).
 * @param {number} duration - Dura√ß√£o do som (ms).
 */
// Contexto global de √°udio ‚Äî evita recriar v√°rias vezes (melhor desempenho)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playBeep(freq = 1000, duration = 300){
  try {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    o.connect(g);
    g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, audioCtx.currentTime + 0.01);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration / 1000);
    o.stop(audioCtx.currentTime + duration / 1000 + 0.02);
  } catch(e){ 
    console.error("Erro ao tocar beep:", e); 
  }
}


/**
 * Toca um som de sucesso (tr√™s tons ascendentes) usando a Web Audio API.
 */
/**
 * Toca um som de erro (dois tons descendentes) usando a Web Audio API.
 */
function playError(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;
    const g = ctx.createGain();
    g.connect(ctx.destination);
    
    // Toca dois tons descendentes (som de erro)
    [440, 330].forEach((f,i)=>{
      const o = ctx.createOscillator();
      o.type='square'; // Onda quadrada para um som mais "duro"
      o.frequency.value=f; 
      o.connect(g);
      // Inicia e para cada tom com um pequeno atraso
      o.start(now+i*0.1); 
      o.stop(now+i*0.1+0.15); 
    });
    setTimeout(()=> ctx.close(),500);
  } catch(e){
    console.error("Erro ao tocar erro:", e);
  }
}

function playSuccess(){
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;
    const g = ctx.createGain();
    g.connect(ctx.destination);
    
    // Toca 5 tons diferentes em sequ√™ncia festiva (mais notas para comemora√ß√£o)
    [660, 784, 880, 1047, 1320].forEach((f,i)=>{
      const o = ctx.createOscillator();
      o.type='sine'; o.frequency.value=f; o.connect(g);
      // Inicia e para cada tom com um pequeno atraso
      o.start(now+i*0.07); 
      o.stop(now+i*0.07+0.1); // Dura√ß√£o ligeiramente maior
    });
    setTimeout(()=> ctx.close(),500);
  } catch(e){
    console.error("Erro ao tocar sucesso:", e);
  }
}


/* ==========================================================================
   L√ìGICA DO CRON√îMETRO
   ========================================================================== */

/**
 * Inicia o cron√¥metro regressivo.
 */
function startTimer(){
  clearInterval(timerInterval); // Limpa qualquer intervalo anterior
  let t = timerSeconds;
  timerCircle.textContent = t;
  timerInterval = setInterval(()=>{
    t--; 
    timerCircle.textContent = t;
    if(t<=0){ 
      clearInterval(timerInterval); 
      onTimerEnd(); // A√ß√£o quando o tempo acaba
    }
  },1000);
}

/**
 * Para o cron√¥metro e reseta o display.
 */
function stopTimer(){ 
  clearInterval(timerInterval); 
  timerCircle.textContent = timerSeconds; 
}

/**
 * Executado quando o cron√¥metro chega a zero no modo Ca√ßa.
 */
function onTimerEnd() {
  playBeep(1000, 400);

  if (mode === 'hunt' && huntTarget !== null) {
    let letraFala = pronunciaLetra[huntTarget] || huntTarget;

    // Cancela falas anteriores com pequeno atraso
    setTimeout(() => {
      speechSynthesis.cancel();

      // Cria a fala e aguarda o t√©rmino
      const u = new SpeechSynthesisUtterance(`O tempo acabou! A resposta era ${letraFala}.`);
      u.lang = 'pt-BR';
      u.rate = 1;
      u.pitch = 1;
      u.onend = () => {
        // S√≥ gera o pr√≥ximo alvo depois que a fala termina
        generateNextTarget();
      };

      speechSynthesis.speak(u);
    }, 150);

    statusBox.textContent = `Tempo esgotado! A resposta era: ${huntTarget}`;
    mainDisplay.textContent = `Tente novamente: ${huntTarget}`;
  }
}


/* ==========================================================================
   L√ìGICA DO MODO CA√áA (HUNT)
   ========================================================================== */

/**
 * Escolhe um item aleat√≥rio da categoria atual (letras ou n√∫meros).
 * @param {string} cat - 'letters' ou 'numbers'.
 * @returns {string} O item escolhido.
 */
function chooseRandomFromCategory(cat){
  const source = cat === 'letters' ? letters : numbers;
  return source[Math.floor(Math.random()*source.length)];
}

/**
 * Gera um novo alvo para o usu√°rio encontrar no modo Ca√ßa.
 */
function generateNextTarget(){
  huntTarget = chooseRandomFromCategory(huntCategory);
  announceTarget();
}

/**
 * Anuncia o alvo atual (visual e por voz) e inicia o cron√¥metro.
 */
function announceTarget(){
  mainDisplay.textContent = `Procure: ${huntTarget}`;
  let letraFala = pronunciaLetra[huntTarget]||huntTarget;
  
  // Fala a instru√ß√£o
  if(huntCategory==='letters') speak(`Encontre a letra ${letraFala}`, {pitch:1.6});
  else speak(`Encontre o n√∫mero ${letraFala}`, {pitch:1.6});
  
  startTimer();
}


/* ==========================================================================
   MANIPULADOR DE INTERA√á√ÉO DE TECLA (Clique ou Teclado F√≠sico/Virtual)
   ========================================================================== */

/**
 * Processa a intera√ß√£o do usu√°rio com uma tecla.
 * @param {string} rawKey - O valor da tecla pressionada (ex: 'A', 'Space').
 */
function handleKeyInteraction(rawKey) {
  // üß© BLOQUEIO: ignora cliques enquanto a voz estiver falando
  if (isSpeaking) return;

  // Converte para string e normaliza
  let displayKey = String(rawKey).trim();

  // üö´ IGNORA teclas inv√°lidas, espa√ßos e caracteres especiais
  // Mant√©m apenas letras (A-Z, a-z) e n√∫meros (0-9)
  if (!/^[a-zA-Z0-9]$/.test(displayKey)) {
    mainDisplay.textContent = `‚Äî`; // Mostra tra√ßo visual em vez do caractere
    return;
  }

  mainDisplay.textContent = `Voc√™ pressionou: ${displayKey}`;
  flashKey(rawKey); // Efeito visual

  if (mode === 'talk') {
    /* üéôÔ∏è MODO FALANTE */
    let fala = displayKey;

    if (letters.includes(displayKey.toUpperCase())) {
      fala = pronunciaLetra[displayKey.toUpperCase()] || displayKey;
    } else if (numbers.includes(displayKey)) {
  fala = pronunciaNumero[displayKey] || displayKey; // fala = 'quatro'
}

    speak(fala);
    statusBox.textContent = `Modo: Falante ‚Äî pressionou ${displayKey}`;
  }

  else if (mode === 'hunt') {
    /* üéØ MODO CA√áA */
    if (!huntTarget) {
      statusBox.textContent = 'Clique em Letras ou N√∫meros para iniciar.';
      return;
    }

    let pressed = huntCategory === 'letters' ? displayKey.toUpperCase() : displayKey;

    if (pressed === huntTarget) {
      /* ‚úÖ ACERTOU */
      stopTimer();
      playSuccess();
      
      // NOVO: Incrementa acertos
      scoreHits++;
      btnAcertos.textContent = `Acertos: ${scoreHits}`;
      // FIM NOVO
      
      let letraFala = pronunciaLetra[huntTarget] || huntTarget;
      const isTargetLetter = huntCategory === 'letters';
      const tipoAlvo = isTargetLetter ? 'letra' : 'n√∫mero';
      const artigoAlvo = isTargetLetter ? 'a' : 'o';

      setTimeout(() => {
        speak(`Parab√©ns, voc√™ acertou ${artigoAlvo} ${tipoAlvo} ${letraFala}`);
        mainDisplay.textContent = `üéâ Acertou: ${huntTarget} üéâ`;
        statusBox.textContent = `Muito bem! Encontrou ${huntTarget}!`;

        // Gera o pr√≥ximo alvo ap√≥s o feedback
        setTimeout(() => generateNextTarget(), 3200);
      }, 600);

    } else {
      /* ‚ùå ERROU */
      playError();
      stopTimer();
      
      // NOVO: Incrementa erros
      scoreMisses++;
      btnErros.textContent = `Erros: ${scoreMisses}`;
      // FIM NOVO
      
      const falaErrado = huntCategory === 'letters' ? (pronunciaLetra[pressed] || pressed) : pressed;
const falaAlvo = huntCategory === 'letters' ? (pronunciaLetra[huntTarget] || huntTarget) : huntTarget;
const isPressedLetter = letters.includes(displayKey.toUpperCase());
const tipoErrado = isPressedLetter ? 'letra' : 'n√∫mero';
const artigoErrado = isPressedLetter ? 'a' : 'o';
const isTargetLetter = huntCategory === 'letters';
const tipoAlvo = isTargetLetter ? 'letra' : 'n√∫mero';
const artigoAlvo = isTargetLetter ? 'a' : 'o';

// Cria as falas
const u1 = new SpeechSynthesisUtterance(`Voc√™ errou!`);
const u2 = new SpeechSynthesisUtterance(`Voc√™ apertou ${artigoErrado} ${tipoErrado} ${falaErrado}`);
const u3 = new SpeechSynthesisUtterance(`Agora procure ${artigoAlvo} ${tipoAlvo} ${falaAlvo} novamente`);

// Configura as vozes
[u1, u2, u3].forEach(u => {
  u.lang = 'pt-BR';
  if (speakingVoice) u.voice = speakingVoice;
  u.rate = 1.0;
  u.pitch = 1.2;
});

// Encadeia as falas (u1 ‚Üí u2 ‚Üí u3)
u1.onend = () => speechSynthesis.speak(u2);
u2.onend = () => speechSynthesis.speak(u3);
u3.onend = () => {
  isSpeaking = false;   // ‚úÖ terminou de falar ‚Äî libera cliques
  startTimer();         // ‚è±Ô∏è reinicia o cron√¥metro s√≥ depois da fala
};

// Inicia a fala
speechSynthesis.cancel();
isSpeaking = true;       // ‚úÖ bloqueia teclas enquanto fala
speechSynthesis.speak(u1);

// Atualiza mensagens na tela
statusBox.textContent = `Voc√™ apertou ${pressed}. Tente novamente: ${huntTarget}`;
mainDisplay.textContent = `‚ùå Procure: ${huntTarget} ‚ùå`;

    }
  }
}



/* ==========================================================================
   FUN√á√ÉO DE PARADA GLOBAL
   ========================================================================== */

/**
 * Para todas as atividades (fala, cron√¥metro, modo ca√ßa).
 */
function stopAllActivity(){
  speechSynthesis.cancel();
  stopTimer();
  huntTarget = null; // Reseta o alvo do modo Ca√ßa
  statusBox.textContent = 'Atividade Parada. Escolha um modo para recome√ßar.';
  mainDisplay.textContent = 'Voc√™ pressionou: ‚Äî';
}


/* ==========================================================================
   MANIPULADORES DE EVENTOS DE BOT√ïES
   ========================================================================== */

/**
 * Reseta a contagem de acertos e erros.
 */
function resetScore() {
  scoreHits = 0;
  scoreMisses = 0;
  btnAcertos.textContent = `Acertos: ${scoreHits}`;
  btnErros.textContent = `Erros: ${scoreMisses}`;
  statusBox.textContent = 'Placar zerado. Comece a jogar!';
  speak('Placar reiniciado', {pitch: 1.4, rate: 0.9});
}

// Evento: Reiniciar Placar
btnReiniciar.addEventListener('click', resetScore);


// Refer√™ncias aos bot√µes de controle
const btnTalk = document.getElementById('modeTalk');
const btnHunt = document.getElementById('modeHunt');
const btnStop = document.getElementById('btnStop');
const btnLetters = document.getElementById('btnLetters');
const btnNumbers = document.getElementById('btnNumbers');
const btnToggleCase = document.getElementById('btnToggleCase');

// Evento: Alternar mai√∫sculas/min√∫sculas
btnToggleCase.addEventListener('click', () => {
  isUpperCase = !isUpperCase; // Inverte o estado
  btnToggleCase.classList.toggle('active', isUpperCase);
  createKeyboardKeys(); // Atualiza o teclado com o novo estado
  btnToggleCase.textContent = isUpperCase ? 'A/a' : 'a/A'; // ‚Üê Adicione esta linha
  hiddenInput.focus();
});


// Evento: Mudar para Modo Falante
btnTalk.addEventListener('click', ()=>{
  mode = 'talk'; 
  btnTalk.classList.add('active'); 
  btnHunt.classList.remove('active');
  stopAllActivity();
  statusBox.textContent = 'Modo: Falante ‚Äî clique uma tecla (ou pressione no teclado).';
  
  // üîä Novo feedback sonoro por voz
  speak('Modo falante ativado', {pitch: 1.4, rate: 0.9});
  
  // For√ßa o foco no input oculto para abrir o teclado virtual em mobile
  hiddenInput.focus(); 
});

// Evento: Mudar para Modo Ca√ßa
btnHunt.addEventListener('click', ()=>{
  mode='hunt'; 
  btnHunt.classList.add('active'); 
  btnTalk.classList.remove('active');
  stopAllActivity();
  statusBox.textContent='Modo: Ca√ßa ‚Äî escolha Letras ou N√∫meros para come√ßar.';
  mainDisplay.textContent='Procure a letra / n√∫mero';
  // For√ßa o foco no input oculto
  hiddenInput.focus(); 
});

// Evento: Parar Tudo
btnStop.addEventListener('click', stopAllActivity);

// Evento: Iniciar Ca√ßa por Letras
btnLetters.addEventListener('click', ()=>{
  if(mode!=='hunt') btnHunt.click(); // Muda para o modo Ca√ßa se ainda n√£o estiver
  huntCategory='letters';
  // Destaca o bot√£o de Letras
  btnLetters.style.background='#6f46f7'; 
  btnNumbers.style.background='var(--purple)';
  generateNextTarget(); // Gera o primeiro alvo
  hiddenInput.focus(); 
});

// Evento: Iniciar Ca√ßa por N√∫meros
btnNumbers.addEventListener('click', ()=>{
  if(mode!=='hunt') btnHunt.click(); // Muda para o modo Ca√ßa se ainda n√£o estiver
  huntCategory='numbers';
  // Destaca o bot√£o de N√∫meros
  btnNumbers.style.background='#6f46f7'; 
  btnLetters.style.background='var(--purple)';
  generateNextTarget(); // Gera o primeiro alvo
  hiddenInput.focus(); 
});


/* ==========================================================================
   MANIPULADORES DE TECLADO F√çSICO E VIRTUAL (MOBILE)
   ========================================================================== */

// Evento: Teclado F√≠sico (Desktop)
document.addEventListener('keydown', (e)=>{ 
  let k=e.key; 
  // Normaliza a tecla Espa√ßo
  if(k===' ') k='Space'; 
  // Ignora teclas de modifica√ß√£o (Shift, Ctrl, Alt, etc.)
  if(e.metaKey || e.ctrlKey || e.altKey || e.shiftKey) return;
  // Evita que o navegador execute a a√ß√£o padr√£o (ex: rolar a p√°gina com a barra de espa√ßo)
  e.preventDefault(); 
  
  // Verifica se a tecla pressionada √© uma que est√° no layout para evitar lixo
  const keyExists = layout.flat().some(key => key.toLowerCase() === k.toLowerCase() || key === k);
  if(keyExists) {
    handleKeyInteraction(k); 
  }
});

// Evento: Input Oculto (Teclado Virtual Mobile)
hiddenInput.addEventListener('input', e => {
  const val = e.target.value;
  if (val) {
    const lastChar = val[val.length - 1];
    let processedChar;

    // Corrigido: se o √∫ltimo caractere for espa√ßo, converte para 'Space'
    if (lastChar === ' ') {
      processedChar = 'Space';
    } else if (letters.includes(lastChar.toUpperCase())) {
      processedChar = lastChar.toUpperCase();
    } else {
      processedChar = lastChar;
    }

    handleKeyInteraction(processedChar);
    e.target.value = '';
  }
});

/* ==========================================================================
   L√ìGICA DE FOCO E ATIVA√á√ÉO DO TECLADO VIRTUAL (MOBILE)
   ========================================================================== */

/**
 * Verifica se o dispositivo √© mobile.
 * @returns {boolean} True se for um dispositivo m√≥vel.
 */
function isMobileDevice() {
    // Checa por userAgent (padr√£o) e por presen√ßa de touch points (para iPads modernos)
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
           (navigator.maxTouchPoints > 0 && screen.width <= 900);
}

/**
 * Tenta focar o input oculto para for√ßar a abertura do teclado virtual no carregamento.
 */
function activateMobileKeyboard() {
    if (isMobileDevice()) {
        // O atraso √© crucial para dar tempo ao browser de processar o carregamento e 
        // garantir que o foco seja aplicado ap√≥s a intera√ß√£o inicial do usu√°rio.
        setTimeout(() => {
            // Tenta focar, mas a abertura do teclado ainda pode depender de um toque do usu√°rio.
            hiddenInput.focus(); 
        }, 100); 
    }
}

// Chame a fun√ß√£o de ativa√ß√£o logo ap√≥s a defini√ß√£o do script
activateMobileKeyboard();

// Foco no input ao tocar no display (Fallback e Manuten√ß√£o de Foco)
// Adiciona um listener no body para focar o input oculto em qualquer toque na tela
document.body.addEventListener('touchstart', (e) => {
    // Evita focar se o toque foi em um bot√£o, para n√£o interferir na navega√ß√£o
    if (!e.target.closest('button')) {
        hiddenInput.focus();
    }
}, {passive: true});

// O evento de click no display continua funcionando como fallback e para desktop
mainDisplay.addEventListener('click', ()=> hiddenInput.focus());

// Previne o "zoom" indesejado ao interagir com as teclas no celular (melhora UX)
document.addEventListener('mousedown', (e)=>{ 
  if(e.target.matches('.key')) e.preventDefault(); 
});


/* ==========================================================================
   L√ìGICA DE SUSPENS√ÉO DE ATIVIDADE
   ========================================================================== */

// Para todas as atividades quando a p√°gina se torna inativa (usu√°rio muda de aba)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    stopAllActivity();
    statusBox.textContent = 'P√°gina inativa. Atividade Suspensa.';
  }
});


/* ==========================================================================
   FINALIZA√á√ÉO E ESTADO INICIAL
   ========================================================================== */

// Configura o estado visual inicial do cron√¥metro e bot√µes de atividade
timerCircle.textContent=timerSeconds;
btnLetters.style.background='var(--purple)'; // Cor padr√£o
btnNumbers.style.background='var(--purple)'; // Cor padr√£o
statusBox.textContent='Modo: Falante ‚Äî pressione uma tecla ou clique.';

</script>

</body>
</html>
